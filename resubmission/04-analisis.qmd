---
author: "Equipo EDUMER"
bibliography: "../input/bib/merit-edjust.bib"
csl: "../input/bib/apa6.csl"
editor_options: 
  chunk_output_type: console
---

```{r}
#| echo: false
#| message: false
#| warning: false

library(knitr)
knitr::opts_chunk$set(echo = TRUE, include = TRUE, warning = FALSE, message = FALSE)

table_format <- if(is_html_output()) {
  "html"
} else if(is_latex_output()) {
  "latex"
}
table_format2 <- if(is_html_output()) {
  T
} else if(is_latex_output()) {
  F
}

options(kableExtra.html.bsTable = T)
options(knitr.kable.NA = "")
```

```{r}
#| label: packages
#| echo: false
#| include: false


if (! require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse, 
               sjmisc, 
               sjPlot, 
               lme4, 
               here, 
               performance,
               marginaleffects,
               texreg, 
               ggdist,
               kableExtra,
               ggalluvial, 
               shadowtext,
               MetBrewer,
               patchwork,
               sjlabelled,
               summarytools,
               interactions,
               cowplot)


options(scipen=999)
rm(list = ls())
```

```{r}
#| label: data
#| echo: false
#| include: false 

load(file = here("input/data/proc/df_study1_long_t7.RData"))

# Generate analytical sample

df_study1 <- df_study1_long_t7 %>%
  select(idencuesta,
         ola,
         ponderador_long_total,
         segmento,
         estrato,
         just_health,
         just_pension,
         just_educ,
         mjp, 
         perc_inequality, 
         merit_effort, 
         merit_talent, 
         educ,
         quintil1,
         sex,
         age,
         ess, 
         ideo) %>% 
  na.omit() %>% 
  mutate(ola = case_when(ola == 1 ~ 1,
                         ola == 2 ~ 2, 
                         ola == 3 ~ 3,
                         ola == 4 ~ 4,
                         ola == 6 ~ 5,
                         ola == 7 ~ 6)) %>% 
  mutate(ola = as.factor(ola),
         ola_num = as.numeric(ola),
         ola_2=as.numeric(ola)^2)

df_study1 <- df_study1 %>%
  group_by(idencuesta) %>%             # Agrupar por el identificador del participante
  mutate(n_participaciones = n()) %>%  # Contar el número de filas (participaciones) por participante
  ungroup()

df_study1 <- df_study1 %>% filter(n_participaciones>1)

# Corregir etiquetas

df_study1$just_health <- sjlabelled::set_label(df_study1$just_health, 
                        label = "Health distributive justice")

df_study1$just_pension <- sjlabelled::set_label(df_study1$just_pension, 
                        label = "Pension distributive justice")

df_study1$just_educ <- sjlabelled::set_label(df_study1$just_educ, 
                        label = "Education distributive justice")

df_study1$merit_effort <- sjlabelled::set_label(df_study1$merit_effort, 
                        label = "People are rewarded for their efforts")

df_study1$merit_talent <- sjlabelled::set_label(df_study1$merit_talent, 
                        label = "People are rewarded for their intelligence")

```

# Results

## Descriptive statistics


@fig-alluvial shows the annual frequencies of market justice preferences for healthcare, pensions, and education from 2016 to 2023. Each year presents stacked percentage frequencies, and the flows between them reflect opinion changes among the same individuals from one year to the next, given that we are using panel data. For instance, of the 40.8% who strongly disagreed with justifying inequality in healthcare in 2019, around 24.3% maintained that position in 2022, while the remaining 16.5% shifted toward other response categories—primarily moving into disagreement rather than strong disagreement. Overall, more than half of the respondents exhibit a high level of disagreement (disagree + strongly disagree) with inequality in these three social service areas over time. Despite this general pattern, recent waves show a slight decrease in disagreement and a corresponding rise in support for market-justice inequality. Specifically, in healthcare and education, although disagreement remains substantial, agreement (agree + strongly agree) increased from 7.4% and 7.2% in 2019 to 13.1% and 14.2% in 2023, respectively. This shift is most evident in pensions, where the combined agree/strongly agree category grew by about 10 percentage points, from 16.9% in 2016 to 28% in 2023.

```{r}
#| label: fig-alluvial
#| out-width: '100%'
#| fig-asp: 1.2
#| fig-cap: "Change in the justification of inequality in healthcare, pensions and education over time (2016-2023)"
#| fig-cap-location: top
#| echo: false
#| results: asis


datos.health <- df_study1 %>% 
  mutate(just_health = factor(just_health, 
                              levels = c("Strongly agree",
                                         "Agree",
                                         "Neither agree nor desagree",
                                         "Desagree",
                                         "Strongly desagree"),
                              ordered = T)) %>% 
  group_by(idencuesta, ola) %>% 
  count(just_health) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=n/sum(n)) %>% 
  ungroup() %>% 
  na.omit() %>% 
  mutate(wave = case_when(ola == 1 ~ "2016",
                          ola == 2 ~ "2017",
                          ola == 3 ~ "2018",
                          ola == 4 ~ "2019",
                          ola == 5 ~ "2022",
                          ola == 6 ~ "2023"),
         wave = factor(wave, levels = c("2016",
                                      "2017",
                                      "2018",
                                      "2019",
                                      "2022",
                                      "2023")))



etiquetas.health <- df_study1 %>%
  mutate(just_health = factor(just_health, 
                              levels = c("Strongly agree",
                                         "Agree",
                                         "Neither agree nor desagree",
                                         "Desagree",
                                         "Strongly desagree"),
                              ordered = T)) %>% 
  group_by(ola, just_health) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(ola) %>%
  mutate(porcentaje = count / sum(count)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1,
         wave = case_when(ola == 1 ~ "2016",
                          ola == 2 ~ "2017",
                          ola == 3 ~ "2018",
                          ola == 4 ~ "2019",
                          ola == 5 ~ "2022",
                          ola == 6 ~ "2023"),
         wave = factor(wave, levels = c("2016",
                                        "2017",
                                        "2018",
                                        "2019",
                                        "2022",
                                        "2023")))




p1 <- datos.health %>% 
  ggplot(aes(x = wave, fill = just_health, stratum = just_health,
             alluvium = idencuesta, y = porcentaje)) +
  ggalluvial::geom_flow(alpha = .4) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values =  c("#0571B0","#92C5DE","#b3b3b3ff","#F4A582","#CA0020")) +
  geom_shadowtext(data = etiquetas.health,
                  aes(label = ifelse(porcentaje > 0 , scales::percent(porcentaje, accuracy = .1),"")),
                  position = position_stack(vjust = .5),
                  show.legend = FALSE,
                  size = 3,
                  color = rep('white'),
                  bg.colour='grey30')+
  labs(y = "%",
       x = NULL,
       fill = NULL,
       title = "a. Healthcare") +
  theme_ggdist() +
  theme(legend.position = "none") 
  


datos.pension <- df_study1 %>% 
   mutate(just_pension = factor(just_pension, 
                              levels = c("Strongly agree",
                                         "Agree",
                                         "Neither agree nor desagree",
                                         "Desagree",
                                         "Strongly desagree"),
                              ordered = T)) %>% 
  group_by(idencuesta, ola) %>% 
  count(just_pension) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=n/sum(n)) %>% 
  ungroup() %>% 
  na.omit() %>% 
  mutate(wave = case_when(ola == 1 ~ "2016",
                          ola == 2 ~ "2017",
                          ola == 3 ~ "2018",
                          ola == 4 ~ "2019",
                          ola == 5 ~ "2022",
                          ola == 6 ~ "2023"),
         wave = factor(wave, levels = c("2016",
                                        "2017",
                                        "2018",
                                        "2019",
                                        "2022",
                                        "2023")))



etiquetas.pension <- df_study1 %>%
  mutate(just_pension = factor(just_pension, 
                              levels = c("Strongly agree",
                                         "Agree",
                                         "Neither agree nor desagree",
                                         "Desagree",
                                         "Strongly desagree"),
                              ordered = T)) %>% 
  group_by(ola, just_pension) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(ola) %>%
  mutate(porcentaje = count / sum(count)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1,
         wave = case_when(ola == 1 ~ "2016",
                          ola == 2 ~ "2017",
                          ola == 3 ~ "2018",
                          ola == 4 ~ "2019",
                          ola == 5 ~ "2022",
                          ola == 6 ~ "2023"),
         wave = factor(wave, levels = c("2016",
                                        "2017",
                                        "2018",
                                        "2019",
                                        "2022",
                                        "2023")))

p2 <- datos.pension %>% 
  ggplot(aes(x = wave, fill = just_pension, stratum = just_pension,
             alluvium = idencuesta, y = porcentaje)) +
  ggalluvial::geom_flow(alpha = .4) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values =  c("#0571B0","#92C5DE","#b3b3b3ff","#F4A582","#CA0020")) +
  geom_shadowtext(data = etiquetas.pension,
                  aes(label = ifelse(porcentaje > 0 , scales::percent(porcentaje, accuracy = .1),"")),
                  position = position_stack(vjust = .5),
                  show.legend = FALSE,
                  size = 3,
                  color = rep('white'),
                  bg.colour='grey30')+
  labs(y = "%",
       x = NULL,
       fill = NULL,
       title = "b. Pensions") +
  theme_ggdist() +
  theme(legend.position = "none") 


datos.educ <- df_study1 %>% 
  mutate(just_educ = factor(just_educ, 
                            levels = c("Strongly agree",
                                         "Agree",
                                         "Neither agree nor desagree",
                                         "Desagree",
                                         "Strongly desagree"),
                              ordered = T)) %>%
  group_by(idencuesta, ola) %>% 
  count(just_educ) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=n/sum(n)) %>% 
  ungroup() %>% 
  na.omit() %>% 
  mutate(wave = case_when(ola == 1 ~ "2016",
                          ola == 2 ~ "2017",
                          ola == 3 ~ "2018",
                          ola == 4 ~ "2019",
                          ola == 5 ~ "2022",
                          ola == 6 ~ "2023"),
         wave = factor(wave, levels = c("2016",
                                        "2017",
                                        "2018",
                                        "2019",
                                        "2022",
                                        "2023")))



etiquetas.educ <- df_study1 %>%
    mutate(just_educ = factor(just_educ, 
                              levels = c("Strongly agree",
                                         "Agree",
                                         "Neither agree nor desagree",
                                         "Desagree",
                                         "Strongly desagree"),
                              ordered = T)) %>%
  group_by(ola, just_educ) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(ola) %>%
  mutate(porcentaje = count / sum(count)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1,
         wave = case_when(ola == 1 ~ "2016",
                          ola == 2 ~ "2017",
                          ola == 3 ~ "2018",
                          ola == 4 ~ "2019",
                          ola == 5 ~ "2022",
                          ola == 6 ~ "2023"),
         wave = factor(wave, levels = c("2016",
                                        "2017",
                                        "2018",
                                        "2019",
                                        "2022",
                                        "2023")))

p3 <- datos.educ %>% 
  ggplot(aes(x = wave, fill = just_educ, stratum = just_educ,
             alluvium = idencuesta, y = porcentaje)) +
  ggalluvial::geom_flow(alpha = .4) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values =  c("#0571B0","#92C5DE","#b3b3b3ff","#F4A582","#CA0020")) +
  geom_shadowtext(data = etiquetas.educ,
                  aes(label = ifelse(porcentaje > 0 , scales::percent(porcentaje, accuracy = .1),"")),
                  position = position_stack(vjust = .5),
                  show.legend = FALSE,
                  size = 3,
                  color = rep('white'),
                  bg.colour='grey30')+
  labs(y = "%",
       x = "Wave",
       fill = NULL,
       title = "c. Education",
       caption = "Source: own elaboration with pooled data from ELSOC 2016-2023 (N obs = 8,643; N groups = 1,687)") +
  theme_ggdist() +
  theme(legend.position = "bottom") 

(p1 / p2 / p3) 

```


Regarding the main dependent and independent variables of this study, @fig-meanchange depicts their standardized average values across survey waves. The results show a notable upward trend in market justice preferences, particularly in the most recent waves. Perceived economic inequality exhibited the highest standardized mean in 2016; however, this variable shows a general downward trajectory over time, with a temporary increase in 2019, possibly reflecting the effects of the social uprising that year. Interestingly, while perceptions of inequality declined in the latest waves (2022–2023), market justice preferences continued to rise. Meritocratic perceptions, in contrast, remain relatively stable overall. Nevertheless, perceptions that individuals are rewarded based on talent tend to be slightly higher than those based on effort. Both meritocracy-related measures follow a similar temporal pattern: an increase from 2016 to 2018, a decline between 2019 and 2022—potentially associated with the social unrest and the consequences of the COVID-19 pandemic—and a subsequent rise in 2023, returning to levels comparable to those observed in 2016.

```{r}
#| label: fig-meanchange
#| out-width: '100%'
#| fig-asp: 0.8
#| fig-cap: "Change in the standarized mean of market justice preferences, economic inequality perception, and meritocracy (2016-2023)"
#| fig-cap-location: top
#| echo: false
#| results: asis


library(srvyr)

df_pond <- df_study1 %>% 
  mutate(ola = case_when(ola == 1 ~ "2016",
                         ola == 2 ~ "2017",
                         ola == 3 ~ "2018",
                         ola == 4 ~ "2019",
                         ola == 5 ~ "2022",
                         ola == 6 ~ "2023"),
         ola = factor(ola, levels = c("2016",
                                        "2017",
                                        "2018",
                                        "2019",
                                        "2022",
                                        "2023"))) %>% 
  as_survey_design(.data = .,
                   ids = segmento, 
                   strata = estrato, 
                   weights = ponderador_long_total)

df_pond <- df_pond %>% 
  select(ola, mjp, perc_inequality, merit_effort, merit_talent) %>% 
  mutate_at(.vars = 2:5, .funs = ~ as.numeric(.)) %>% 
  mutate(
    mjp_z            = as.numeric(scale(mjp)),
    perc_inequality_z = as.numeric(scale(perc_inequality)),
    merit_effort_z    = as.numeric(scale(merit_effort)),
    merit_talent_z    = as.numeric(scale(merit_talent))
  )


df_pond %>% 
  select(ola, mjp_z, perc_inequality_z, merit_effort_z, merit_talent_z) %>% 
  group_by(ola) %>% 
  summarise_all(~survey_mean(., vartype = "ci")) %>% 
  pivot_longer(cols = -ola,
               names_to = "temp",
               values_to = "valor") %>%
  mutate(
    ci = case_when(
      str_ends(temp, "_low") ~ "ic_low",
      str_ends(temp, "_upp") ~ "ic_upp",
      TRUE                   ~ "mean"
    ),
    variable = str_remove(temp, "_low|_upp")
  ) %>%
  select(ola, variable, ci, valor) %>%
  pivot_wider(
    names_from  = ci,
    values_from = valor
  ) %>% 
  mutate(variable = case_when(variable == "mjp_z" ~ "Market justice preferences",
                              variable == "perc_inequality_z"  ~ "Inequality perception",
                              variable == "merit_effort_z"     ~ "Merit: Effort",
                              variable == "merit_talent_z"     ~ "Merit: Talent"),
         variable = factor(variable, levels = c("Market justice preferences",
                                      "Inequality perception",
                                      "Merit: Effort",
                                      "Merit: Talent")
                              )) %>% 
  ggplot(aes(x = ola, y = mean, group = variable)) +
  geom_point(aes(shape=variable, color=variable), size = 3.5) +
  geom_line(aes(color = variable), linewidth = 0.8) +
  geom_errorbar(aes(ymin = ic_low, ymax = ic_upp, color = variable),
                width = 0.1) +
  scale_color_manual(values = c("#023858", # azul oscuro
                                "#0571B0", # azul intermedio
                                "#F4A582", # salmón
                                "#B2182B"  # rojo profundo
                                         )) +
  scale_shape_manual(values=c(15, 16, 17, 18)) +
  labs(y = "Mean (Z-score)",
       x = "Wave",
       color = NULL,
       shape = NULL,
       caption = "Source: own elaboration with pooled data from ELSOC 2016-2023 (N obs = 8,643; N groups = 1,687)") +
  theme_ggdist() +
  theme(legend.position = "top",
        text = element_text(size = 12)) 
 
```

## Multilevel models

@tbl-modelos presents the results of the multilevel models estimated for market justice preferences, examining both individuals (within) and group-level (between) effects. The intraclass correlation [@hoxMultilevelAnalysisTechniques2017a] from the empty model (see Supplementary Material), which decomposes the variance of market justice preferences, is 0.31, indicating that approximately 31% of the variation is attributable to differences between individuals. Complementary, 69% of the variation corresponds to within-individual differences over time.


```{r, echo=FALSE, include=FALSE}

df_study1$merit_effort <- as_numeric(df_study1$merit_effort)
df_study1$merit_talent <- as_numeric(df_study1$merit_talent)

df_study1 <- df_study1 %>% 
  mutate(ola = case_when(ola == 1 ~ "2016",
                         ola == 2 ~ "2017",
                         ola == 3 ~ "2018",
                         ola == 4 ~ "2019",
                         ola == 5 ~ "2022",
                         ola == 6 ~ "2023"),
         ola = factor(ola, levels = c("2016",
                                        "2017",
                                        "2018",
                                        "2019",
                                        "2022",
                                        "2023")))


df_study1 <- df_study1 %>% 
  group_by(idencuesta) %>% 
  mutate(perc_inequality_mean = mean(perc_inequality, na.rm = T),
         perc_inequality_cwc = perc_inequality - perc_inequality_mean,
         merit_effort_mean = mean(merit_effort, na.rm = T),
         merit_effort_cwc = merit_effort - merit_effort_mean,
         merit_talent_mean = mean(merit_talent, na.rm = T),
         merit_talent_cwc = merit_talent - merit_talent_mean,
         ) %>% 
  ungroup()
```



```{r}
#| echo: false
#| include: false 

m0 <- lmer(mjp ~ 1 + (1 | idencuesta), 
                data = df_study1, weights = ponderador_long_total)

performance::icc(m0, by_group = T)

df_study1 <- df_study1 %>%
  mutate(
    perc_inequality_cwc_dic = ifelse(perc_inequality_cwc > mean(perc_inequality_cwc, na.rm = TRUE), "mayor", "menor"),
    merit_effort_cwc_dic = ifelse(merit_effort_cwc > mean(merit_effort_cwc, na.rm = TRUE), "mayor", "menor"),
    merit_talent_cwc_dic = ifelse(merit_talent_cwc > mean(merit_talent_cwc, na.rm = TRUE), "mayor", "menor"),
    perc_inequality_mean_dic = ifelse(perc_inequality_mean > mean(perc_inequality_mean, na.rm = TRUE), "mayor", "menor"),
    merit_effort_mean_dic = ifelse(merit_effort_mean > mean(merit_effort_mean, na.rm = TRUE), "mayor", "menor"),
    merit_talent_mean_dic = ifelse(merit_talent_mean > mean(merit_talent_mean, na.rm = TRUE), "mayor", "menor")
  ) %>%
  mutate(across(ends_with("_dic"), factor, levels = c("menor", "mayor")))

## WE and BE

m1 <- lmer(mjp ~ 1 + ola + (1 | idencuesta),
                data = df_study1, weights = ponderador_long_total)

m1.1 <- lmer(mjp ~ 1 + ola_num + ola_2 + (1 | idencuesta),
                data = df_study1, weights = ponderador_long_total)

m2 <- lmer(mjp ~ 1 + ola_num + ola_2 + (1 + ola_num | idencuesta),
                data = df_study1, weights = ponderador_long_total)

anova(m1.1, m2)

m3 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc + (1 + ola_num | idencuesta), 
           data = df_study1, weights = ponderador_long_total)

m4 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc + merit_effort_cwc + merit_talent_cwc + (1 + ola_num | idencuesta),
                data = df_study1, weights = ponderador_long_total)

m5 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc + merit_effort_cwc + merit_talent_cwc + perc_inequality_mean +  (1 + ola_num | idencuesta),
                data = df_study1, weights = ponderador_long_total)

m6 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc + merit_effort_cwc + merit_talent_cwc + perc_inequality_mean +  merit_effort_mean + merit_talent_mean + (1 + ola_num | idencuesta),
                data = df_study1, weights = ponderador_long_total)

m7 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc + merit_effort_cwc + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + (1 + ola_num | idencuesta),
                data = df_study1, weights = ponderador_long_total)


# interactions 
m8 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc + merit_effort_cwc + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
             merit_effort_cwc_dic*perc_inequality_cwc_dic + merit_talent_cwc*perc_inequality_cwc +
              (1 + merit_effort_cwc + merit_talent_cwc + perc_inequality_cwc | idencuesta),
                data = df_study1, weights = ponderador_long_total)

m8.1 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc + merit_effort_cwc + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
             merit_effort_cwc*perc_inequality_cwc +
              (1 + merit_effort_cwc + perc_inequality_cwc | idencuesta),
                data = df_study1, weights = ponderador_long_total)

m8.2 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc + merit_effort_cwc + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
             merit_talent_cwc*perc_inequality_cwc +
              (1 + merit_talent_cwc + perc_inequality_cwc | idencuesta),
                data = df_study1, weights = ponderador_long_total)

m9 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc +  merit_effort_cwc + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
             merit_effort_mean*perc_inequality_mean + merit_talent_mean*perc_inequality_mean +
              (1 | idencuesta),
                data = df_study1, weights = ponderador_long_total)

m9.1 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc +  merit_effort_cwc + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
             merit_effort_mean*perc_inequality_mean +
              (1 | idencuesta),
                data = df_study1, weights = ponderador_long_total)

m9.2 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc +  merit_effort_cwc + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
             merit_talent_mean*perc_inequality_mean +
              (1 | idencuesta),
                data = df_study1, weights = ponderador_long_total)

# growth curves

m10 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality*ola_num + merit_effort + merit_talent + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + (1 + perc_inequality + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total)

m10.1 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc*ola_num + merit_effort_cwc + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + (1 + perc_inequality_cwc + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total)

m10.2 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc + merit_effort_cwc + merit_talent_cwc + perc_inequality_mean*ola_num + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + (1 + perc_inequality_mean + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total)


m11 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality + merit_effort*ola_num  + merit_talent + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + (1 + merit_effort + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total)

m11.1 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc + merit_effort_cwc*ola_num  + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + (1 + merit_effort_cwc + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total) 

m11.2 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc + merit_effort_cwc  + merit_talent_cwc + perc_inequality_mean + merit_effort_mean*ola_num + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + (1 + merit_effort_mean + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total) 

m12 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc +  merit_effort + merit_talent*ola_num + perc_inequality_mean +  merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
              (1 + merit_talent + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total)

m12.1 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc +  merit_effort_cwc + merit_talent_cwc*ola_num + perc_inequality_mean +  merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
              (1 + merit_talent_cwc + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total) 

m12.2 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc +  merit_effort_cwc + merit_talent_cwc + perc_inequality_mean +  merit_effort_mean + merit_talent_mean*ola_num + educ + quintil1 + ess + ideo + sex + age + 
              (1 + merit_talent_mean + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total) 

m13 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality  + merit_effort + merit_talent + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
             merit_effort*perc_inequality*ola_num +
              (1 + perc_inequality + merit_effort  + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total)

m13.1 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc  + merit_effort_cwc + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
             merit_effort_cwc*perc_inequality_cwc*ola_num +
              (1 + perc_inequality_cwc + merit_effort_cwc + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total)

m13.2 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc  + merit_effort_cwc + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
             ola_num*merit_effort_mean*perc_inequality_mean +
              (1 + perc_inequality_mean + merit_effort_mean  + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total)

m14 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality +  merit_effort + merit_talent + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
              merit_talent*perc_inequality*ola_num +
              (1 + perc_inequality + merit_talent + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total) 

m14.1 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc +  merit_effort_cwc + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
              merit_talent_cwc*perc_inequality_cwc*ola_num +
              (1 + perc_inequality_cwc + merit_talent_cwc + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total) 

m14.2 <- lmer(mjp ~ 1 + ola_num + ola_2 + perc_inequality_cwc +  merit_effort_cwc + merit_talent_cwc + perc_inequality_mean + merit_effort_mean + merit_talent_mean + educ + quintil1 + ess + ideo + sex + age + 
              merit_talent_mean*perc_inequality_mean*ola_num +
              (1 + perc_inequality_mean + merit_talent_mean + ola_num| idencuesta),
                data = df_study1, weights = ponderador_long_total) 



#texreg(list(m13.1, m13.2,m14.1, m14.2))
```

```{r, include=FALSE, eval=FALSE}
interactions::interact_plot(m13.2, pred = "merit_effort_mean", modx="perc_inequality_mean", mod2="ola_num")
```


```{r echo=FALSE, results='asis'}
#| label: tbl-modelos
#| tbl-cap: "Longitudinal multilevel models for market justice preferences"
#| tbl-cap-location: top

omit <- "(educ)|(quintil1)|(ess)|(ideo)|(sex)|(age)"

ccoef <- list(
  "(Intercept)" = "Intercept",
  "ola2017" = "Wave 2017",
  "ola2018" = "Wave 2018",
  "ola2019" = "Wave 2019",
  "ola2022" = "Wave 2022",
  "ola2023" = "Wave 2023",
  ola_num = "Wave",
  ola_2 = "Wave^2",
  perc_inequality_cwc = "Perception inequality (WE)",
  merit_effort_cwc = "Merit: Effort (WE)",
  merit_talent_cwc = "Merit: Talent (WE)",
  perc_inequality_mean = "Perception inequality (BE)",
  merit_effort_mean = "Merit: Effort (BE)",
  merit_talent_mean = "Merit: Talent (BE)"
  )

texreg::texreg(list(m1, m2, m3, m4, m5, m6, m7),
               custom.model.names = c(paste0("Model ", seq(1:7))),caption.above = T,
               caption = NULL,
               stars = c(0.05, 0.01, 0.001),
               omit.coef = omit,
               custom.coef.map = ccoef,
               digits = 3,
               groups = list("Wave (Ref.= 2016)" = 2:6),
               custom.note = "Note: Cells contain regression coefficients with standard errors in parentheses. %stars.",
               leading.zero = T,
               use.packages = F,
               booktabs = F,
               scalebox = 0.80,
               include.loglik = FALSE,
               include.aic = FALSE,
               center = T,
               custom.gof.names = c("BIC", "Numb. obs.", "Num. groups: individuals", "Var: individuals (Intercept)", "Var: Residual", "Var: individuals, wave", "Cov: individuals (Intercept), wave"),
               custom.gof.rows = list("Controls"=c(rep("No",6), "Yes")))
               

```

According to Model 1, which includes the survey waves to capture intertemporal variations in the dependent variable, there is a decrease in 2017 ($\beta$ = -0.183, $p$ < .001) relative to 2016, and similarly in 2018 ($\beta$ = -0.009, $p$ > .05) and 2019 ($\beta$ = -0.009, $p$ > .05), although the latter effects are not statistically significant. In contrast, in the more recent waves of 2022 and 2023, there is a statistically significant increase in market justice preferences ($\beta$ = 0.300, $p$ < .001; $\beta$ = 0.320, $p$ < .001), suggesting a non-linear effect. To model this trajectory over time, Model 2 incorporates time (survey waves) as a continuous variable, along with its quadratic term, representing the non-linear association initially observed in Model 1. While the linear term (survey wave) shows a negative association, reflecting an overall decline in market preferences over time, the positive quadratic term indicates a reversal of this pattern in the final measurement points.

Models 3 and 4 incorporate the within-group effects (WE) of the primary independent variables, capturing how individual changes in these variables over time shape the dependent variable. The results in Model 3 suggest that the within effect of perceived economic inequality is negative and statistically significant ($p$ < .001). Specifically, each one-point increase in an individual’s perception of economic inequality between waves is associated with a 0.027 point decrease in market justice preferences. Model 4 shows that meritocratic perceptions operate in distinct directions. An upward shift in the perception that effort is rewarded exerts a positive within effect ($\beta$ = 0.070, $p$ < .001), while a parallel increase in the perception that intelligence and ability are rewarded is likewise associated with lower market-justice preferences ($\beta$ = -0.027, $p$ < .05). Taken together, these results suggest that people who increasingly perceive meritocracy based on effort tend to have stronger preferences for market justice, and that the opposite is true for those who increasingly perceive meritocracy based on talent.


When examining the between-group effects (BE) in Model 5 and 6, which capture differences between individuals in the average of the main variables, a similar pattern emerges. Individuals who perceive higher levels of economic inequality tend to prefer less market justice ($\beta$ = -0.002, $p$ > .05). However, this effect is no longer statistically significant. In Model 6, the meritocratic perception that effort is rewarded is positively associated with market justice preferences ($\beta$ = 0.206, $p$ < .001), whereas the perception that talent is rewarded shows a positive but non-significant coefficient ($\beta$ = 0.036, $p$ > .05).

Model 7 adds the control variables. The within- and between-effects of the principal predictors retain both their direction and statistical significance, confirming the robustness of the associations (see Supplementary Material for effects of control variables).


```{r echo=FALSE, results='asis'}
#| label: tbl-interactions1
#| tbl-cap: "Interactions for meritocracy, perceived economic inequality and market justice preferences"
#| tbl-cap-location: top

ccoef <- list(
  "(Intercept)" = "Intercept",
  perc_inequality_cwc = "Perception inequality (WE)",
  merit_effort_cwc = "Merit: Effort (WE)",
  merit_talent_cwc = "Merit: Talent (WE)",
  perc_inequality_mean = "Perception inequality (BE)",
  merit_effort_mean = "Merit: Effort (BE)",
  merit_talent_mean = "Merit: Talent (BE)",
  "perc_inequality_cwc:merit_effort_cwc" = "Merit: Effort (WE) x Perception inequality (WE)",
  "perc_inequality_cwc:merit_talent_cwc" = "Merit: Talent (WE) x Perception inequality (WE)",
  "perc_inequality_mean:merit_effort_mean" = "Merit: Effort (BE) x Perception inequality (BE)",
  "perc_inequality_mean:merit_talent_mean" = "Merit: Talent (BE) x Perception inequality (BE)"
  )

texreg::texreg(list(m8.1,m8.2,m9.1,m9.2),
               custom.model.names = c("Model 8", "Model 9", "Model 10", "Model 11"),
               caption = NULL,
               caption.above = T,
               stars = c(0.05, 0.01, 0.001),
               custom.coef.map = ccoef,
               digits = 3,
               custom.note = "Note: Cells contain regression coefficients with standard errors in parentheses. %stars. CWC = centered within group.",
               leading.zero = T,
               use.packages = F,
               booktabs = F,
               scalebox = 0.8,
               include.loglik = FALSE,
               include.aic = FALSE,
               center = T,
               custom.gof.names = c("BIC", 
                                    "Numb. obs.", 
                                    "Num. groups: individuals", 
                                    "Var: individuals (Intercept)", 
                                    "Var: individuals, merit effort cwc", 
                                    "Var: individuals, perception inequality cwc", 
                                    "Cov: individuals (Intercept), merit effort cwc",
                                    "Cov: individuals (Intercept), perception inequality cwc",
                                    "Cov: individuals, merit effort cwc, perception inequality cwc",
                                    "Var: Residuals",
                                    "Var: individuals, merit talent cwc", 
                                    "Cov: individuals (Intercept), merit talent cwc",
                                    "Cov: individuals, merit talent cwc, perception inequality cwc"),
               custom.gof.rows = list("Controls"=c(rep("Yes",4))))




```

```{r}
#| label: fig-interact
#| out-width: '100%'
#| fig-asp: 1
#| fig-cap: "Predicted values of market justice preferences by perceptions of meritocraticy and economic inequality"
#| fig-cap-location: top
#| echo: false
#| results: asis


library(ggeffects)

min_val <- min(df_study1$perc_inequality_mean, na.rm = TRUE)
max_val <- max(df_study1$perc_inequality_mean, na.rm = TRUE)
mean_val <- mean(df_study1$perc_inequality_mean, na.rm = TRUE)

p6 <- ggpredict(
  m9.1,
  terms = c("merit_effort_mean", 
            sprintf("perc_inequality_mean [%.2f, %.2f]", min_val, max_val))
) %>% 
  plot() +
  scale_x_continuous(n.breaks = 5) +
  scale_color_manual(
    name = "Perception of inequality (BE)",
    values = c("#0571B0",  "#B2182B"),
    labels = c("Min",  "Max")
  ) +
  scale_fill_manual(
    name = "Perception of inequality (BE)",
    values = c("#0571B0",  "#B2182B"),
    labels = c("Min",  "Max")) +
  labs(
    x = "Merit: Effort (BE)",
    y = "Market justice preferences",
    title = "(A) People are rewarded by their efforts") +
  theme_ggdist()

p7 <- ggpredict(
  m9.2,
  terms = c("merit_talent_mean", 
            sprintf("perc_inequality_mean [%.2f, %.2f]", min_val, max_val))
) %>% 
  plot() +
  scale_x_continuous(n.breaks = 5) +
  scale_color_manual(
    name = "Perception of inequality (BE)",
    values = c("#0571B0",  "#B2182B"),
    labels = c("Min",  "Max")
  ) +
  scale_fill_manual(
    name = "Perception of inequality (BE)",
    values = c("#0571B0",  "#B2182B"),
    labels = c("Min",  "Max")) +
  labs(
    x = "Merit: Talent (BE)",
    y = "Market justice preferences",
    title = "(B) People are rewarded for their intelligence",
  caption = "Source: own elaboration with data from ELSOC 2016-2023 (n = 8460). Based in Model 10 and Model 11 in Table 4") +
  theme_ggdist()

library(ggpubr)
ggpubr::ggarrange(p6, p7, common.legend=TRUE, ncol=1, legend = "top")

```

@tbl-interactions1 examines whether perceived economic inequality moderates the effect of meritocratic perceptions on market justice preferences. Contrary to our expectations, the interaction terms in the within-person specification of Model 9 indicate that the negative effect of talent-based meritocratic perceptions becomes stronger as perceived inequality increases ($\beta$ = -0.032, $p$ < .05). In contrast, in the between-person specification (Model 11), the interaction term is positive ($\beta$ = 0.099, $p$ < .01), suggesting that perceptions of economic inequality significantly shape the influence of meritocratic perceptions on support for market-based allocation of social services. Specifically, these positive effects indicate that, as perceptions of inequality increase, the association between talent-based meritocratic perceptions and market justice preferences shifts in a positive direction.

The effects of effort-based meritocratic perceptions are not statistically significant in either the within- or between-person specifications (Models 8 and 10). However, the direction of the coefficients is negative in the former and positive in the latter. As shown in @fig-interact, Panel A, the between-person effect of effort-based meritocratic perceptions on market justice preferences strengthens as perceived inequality increases across individuals, whereas this effect weakens among those who perceive lower levels of inequality. Panel B reveals a similar pattern for the between-person effect of talent-based meritocratic perceptions, although the effect is substantially weaker at low levels of perceived inequality.

Substantively, these findings suggest that the legitimizing function of meritocratic perceptions is amplified in contexts perceived as highly unequal. In such contexts, meritocratic narratives may reinforce individualistic understandings of distributive justice and intensify support for market-based access to essential social services.

Regarding the temporal dynamics of the key predictors, the analysis shows that time has no statistically significant effects on the intrapersonal or interpersonal effects of perceived inequality and meritocratic perceptions. Further details about this analysis can be found in supplementary material.
